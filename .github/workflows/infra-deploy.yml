name: terraform AWS deployment
run-name: ${{ inputs.action }} ${{ inputs.module }}

on:
  workflow_dispatch:
    inputs:
      module:
        description: 'Terraform Module to Deploy'
        required: true
        default: all
        type: choice
        options:
          - all
          - vpc
          - sg
          - ec2
          - alb
          - rds
          
      action:
        description: 'Terraform Action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

env:
    ACTION: ${{ github.event.inputs.action || 'plan' }}
    MODULE: ${{ github.event.inputs.module || 'all' }}
    WORKING_DIR: terraform
    TF_VERSION: 1.13.0

permissions:
  contents: read
  pull-requests: read

jobs:
  terraform:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Init
        run: terraform init

      - name: AWS Cleanup Before Destroy
        if: ${{ env.ACTION == 'destroy' }}
        run: |
          VPC_ID="vpc-02fc83fac9fa9d016"
          
          ENI_IDS=$(aws ec2 describe-network-interfaces \
            --filters Name=vpc-id,Values=$VPC_ID \
            --query 'NetworkInterfaces[].NetworkInterfaceId' \
            --output text 2>/dev/null || echo "")
          
          if [ ! -z "$ENI_IDS" ]; then
            for ENI_ID in $ENI_IDS; do
              aws ec2 delete-network-interface --network-interface-id $ENI_ID 2>/dev/null || true
            done
          fi
          
          sleep 30
          
          ALB_ARN=$(aws elbv2 describe-load-balancers --query "LoadBalancers[?VpcId=='$VPC_ID'].LoadBalancerArn" --output text 2>/dev/null || echo "")
          
          if [ ! -z "$ALB_ARN" ]; then
            aws elbv2 delete-load-balancer --load-balancer-arn $ALB_ARN 2>/dev/null || true
          fi
          
          TG_ARNS=$(aws elbv2 describe-target-groups --query "TargetGroups[?VpcId=='$VPC_ID'].TargetGroupArn" --output text 2>/dev/null || echo "")
          
          if [ ! -z "$TG_ARNS" ]; then
            for TG_ARN in $TG_ARNS; do
              aws elbv2 delete-target-group --target-group-arn $TG_ARN 2>/dev/null || true
            done
          fi
          
          sleep 30
          
          SG_IDS=$(aws ec2 describe-security-groups \
            --filters Name=vpc-id,Values=$VPC_ID \
            --query 'SecurityGroups[?GroupName!=`default`].GroupId' \
            --output text 2>/dev/null || echo "")
          
          if [ ! -z "$SG_IDS" ]; then
            for SG_ID in $SG_IDS; do
              aws ec2 delete-security-group --group-id $SG_ID 2>/dev/null || true
            done
          fi
          
          sleep 30
      
      - name: Terraform Action
        run: |
          case "${MODULE}" in
            vpc) TARGET="-target=module.vpc" ;;
            sg)  TARGET="-target=module.security_groups" ;;
            ec2) TARGET="-target=module.ec2" ;;
            alb) TARGET="-target=module.alb" ;;
            rds) TARGET="-target=module.rds" ;;
            all) TARGET="" ;;
          esac
          
          case "${ACTION}" in
            plan)
              terraform plan -no-color -out=tfplan $TARGET
              ;;
            apply)
              terraform plan -no-color -out=tfplan $TARGET
              terraform apply -auto-approve tfplan 
              ;;
            destroy)
              terraform destroy -auto-approve $TARGET || true
              sleep 30
              terraform destroy -auto-approve $TARGET || true
              sleep 30
              terraform refresh
              terraform destroy -auto-approve $TARGET
              ;;
          esac

  build-and-push:
    if: ${{ github.event.inputs.module == 'all' && github.event.inputs.action == 'apply' }}
    needs: terraform
    uses: ./.github/workflows/auto-build-and-push.yml
    secrets: inherit

  deploy:
    if: ${{ github.event.inputs.module == 'all' && github.event.inputs.action == 'apply' }}
    needs: [build-and-push, terraform]
    uses: ./.github/workflows/auto-deploy.yml
    with:
      tag: latest
    secrets: inherit
