name: terraform AWS deployment
run-name: ${{ inputs.action }} ${{ inputs.module }}

on:
  workflow_dispatch:
    inputs:
      module:
        description: 'Terraform Module to Deploy'
        required: true
        default: all
        type: choice
        options:
          - all
          - vpc
          - sg
          - ec2
          - alb
          - rds
          
      action:
        description: 'Terraform Action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

env:
    ACTION: ${{ github.event.inputs.action || 'plan' }}
    MODULE: ${{ github.event.inputs.module || 'all' }}
    WORKING_DIR: terraform
    TF_VERSION: 1.13.0

permissions:
  contents: read
  pull-requests: read

jobs:
  terraform:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Init
        run: terraform init

      - name: Cleanup AWS Dependencies Before Destroy
        if: ${{ env.ACTION == 'destroy' }}
        run: |
          echo "Cleaning up AWS dependencies before destroy..."
          
          # Get VPC ID from Terraform state or use known ID
          VPC_ID="vpc-02fc83fac9fa9d016"
          
          echo "Cleaning up resources in VPC: $VPC_ID"
          
          # 1. Delete Network Interfaces
          echo "Checking for Network Interfaces..."
          ENI_IDS=$(aws ec2 describe-network-interfaces \
            --filters Name=vpc-id,Values=$VPC_ID \
            --query 'NetworkInterfaces[].NetworkInterfaceId' \
            --output text 2>/dev/null || echo "")
          
          if [ ! -z "$ENI_IDS" ]; then
            echo "Found Network Interfaces: $ENI_IDS"
            for ENI_ID in $ENI_IDS; do
              echo "Deleting Network Interface: $ENI_ID"
              aws ec2 delete-network-interface --network-interface-id $ENI_ID || echo "Failed to delete ENI $ENI_ID, continuing..."
            done
          else
            echo "No Network Interfaces found"
          fi
          
          # 2. Wait for ENI deletions to propagate
          echo "Waiting for cleanup to propagate..."
          sleep 30
          
          # 3. Try to delete non-default Security Groups
          echo "Checking for Security Groups..."
          SG_IDS=$(aws ec2 describe-security-groups \
            --filters Name=vpc-id,Values=$VPC_ID \
            --query 'SecurityGroups[?GroupName!=`default`].GroupId' \
            --output text 2>/dev/null || echo "")
          
          if [ ! -z "$SG_IDS" ]; then
            echo "Found Security Groups: $SG_IDS"
            for SG_ID in $SG_IDS; do
              echo "Attempting to delete Security Group: $SG_ID"
              aws ec2 delete-security-group --group-id $SG_ID || echo "Failed to delete SG $SG_ID, continuing..."
            done
          else
            echo "No Security Groups found"
          fi
          
          # 4. Delete Internet Gateway if attached
          echo "Checking for Internet Gateway..."
          IGW_ID=$(aws ec2 describe-internet-gateways \
            --filters Name=attachment.vpc-id,Values=$VPC_ID \
            --query 'InternetGateways[].InternetGatewayId' \
            --output text 2>/dev/null || echo "")
          
          if [ ! -z "$IGW_ID" ]; then
            echo "Found Internet Gateway: $IGW_ID"
            # First detach
            aws ec2 detach-internet-gateway --internet-gateway-id $IGW_ID --vpc-id $VPC_ID || echo "Failed to detach IGW, continuing..."
            # Then delete
            aws ec2 delete-internet-gateway --internet-gateway-id $IGW_ID || echo "Failed to delete IGW, continuing..."
          fi
          
          echo " Pre-destroy cleanup completed"
      
      - name: Terraform Action (${{ env.ACTION }})
        run: |
          case "${MODULE}" in
            vpc) TARGET="-target=module.vpc" ;;
            sg)  TARGET="-target=module.security_groups" ;;
            ec2) TARGET="-target=module.ec2" ;;
            alb) TARGET="-target=module.alb" ;;
            rds) TARGET="-target=module.rds" ;;
            all) TARGET="" ;;
          esac
          
          case "${ACTION}" in
            plan)
              terraform plan -no-color -out=tfplan $TARGET
              ;;
            apply)
              terraform plan -no-color -out=tfplan $TARGET
              terraform apply -auto-approve tfplan 
              ;;
            destroy)
              echo " Starting Terraform destroy..."
              # First attempt
              terraform destroy -auto-approve $TARGET || true
              
              # If first attempt fails, wait and retry
              echo " Waiting before retry..."
              sleep 45
              
              # Second attempt
              echo "Second destroy attempt..."
              terraform destroy -auto-approve $TARGET
              ;;
          esac
        shell: bash

  build-and-push:
    if: ${{ github.event.inputs.module == 'all' && github.event.inputs.action == 'apply' }}
    needs: terraform
    uses: ./.github/workflows/auto-build-and-push.yml
    secrets: inherit

  deploy:
    if: ${{ github.event.inputs.module == 'all' && github.event.inputs.action == 'apply' }}
    needs: [build-and-push, terraform]
    uses: ./.github/workflows/auto-deploy.yml
    with:
      tag: latest
    secrets: inherit
